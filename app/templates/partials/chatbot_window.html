<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cleaned Up Page</title>
  <style>
    /* MAIN CONTAINER */
    .chat-container {
      display: flex;
      height: 80vh; /* Ensure the page height is maximum 100% */
      font-family: 'Inter', sans-serif;
      color: #1f2937;
      background-color: #f9fafb;
      transition: margin-left 0.3s ease-in-out; /* for shifting container */
    }
    /* Class to shift chat-container to the right when history is open */
    .chat-container.move-right {
      margin-left: 300px; /* matches the .chat-history width */
    }
/* Style any tables generated inside a .message.bot .message-content */
.message.bot .message-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 0;
  font-size: 0.95rem;
  min-width: 300px;
  background-color: #fff; /* Optional, if you want a white background */
}

/* Table heading styles */
.message.bot .message-content thead {
  background-color: #f9fafb; /* Slightly lighter background */
  border-bottom: 2px solid #e5e7eb;
}
.message.bot .message-content thead th {
  font-weight: 600;
  color: #374151;            /* Tailwind Gray-700 */
  padding: 0.75rem 1rem;
  text-align: left;
}

/* Table body row styling */
.message.bot .message-content tbody tr {
  border-bottom: 1px solid #e5e7eb;
}
.message.bot .message-content tbody tr:nth-child(even) {
  background-color: #f3f4f6; /* Subtle row striping */
}
.message.bot .message-content tbody tr:hover {
  background-color: #e5e7eb; /* Hover highlight */
}

/* Table cell styling */
.message.bot .message-content td {
  padding: 0.75rem 1rem;
  color: #4b5563;
  vertical-align: middle; /* center text vertically */
}

/* (Optional) Center numeric columns (Yes, No, Abstained) */
.message.bot .message-content td:nth-child(2),
.message.bot .message-content td:nth-child(3),
.message.bot .message-content td:nth-child(4) {
  text-align: center;
}

    /* CHAT MAIN AREA */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative; /* so the toggle button could be placed if desired */
    }
    .example-questions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      padding: 1.5rem;
      background-color: #fff;
      border-bottom: 1px solid #e5e7eb;
      align-items: center; /* so our history button lines up well */
    }
    .example-question {
      padding: 0.75rem 1.25rem;
      background-color: #f3f4f6;
      border-radius: 0.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
      border: 1px solid #e5e7eb;
      color: #4b5563;
    }
    .example-question:hover {
      background-color: #e5e7eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .message {
      max-width: 80%;
      padding: 1rem 1.25rem;
      border-radius: 1rem;
      position: relative;
      animation: fadeIn 0.3s ease-out;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .message.user {
      margin-left: auto;
      background-color: #3b82f6;
      color: #fff;
    }
    .message.bot {
      margin-right: auto;
      background-color: #fff;
      border: 1px solid #e5e7eb;
    }
    .message-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      font-weight: 500;
    }
    .message-content {
      line-height: 1.6;
    }

    /* CITATIONS */
    .citation-links {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .citation-link {
      padding: 0.25rem;
      color: #3b82f6;
      font-size: 0.9rem;
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 2px;
      transition: opacity 0.2s;
    }
    .citation-link:hover {
      opacity: 0.8;
    }

    /* INPUT AREA */
    .input-container {
      padding: 1.5rem;
      background-color: #fff;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 1rem;
      align-items: center;
      position: relative;
    }
    .chat-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: box-shadow 0.2s;
      color: #4b5563;
    }
    .chat-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    .send-button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background-color: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .send-button:hover {
      background-color: #2563eb;
    }
    .send-button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }

    /* STATEMENT SIDEBAR */
    .sidebar-overlay {
      /* This overlay remains for the statement sidebar only (if needed). */
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      pointer-events: none;
      z-index: 100;
    }
    .sidebar-overlay.active {
      opacity: 1;
      pointer-events: all;
    }
    .sidebar {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 900px;
      background-color: #fff;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
      z-index: 101;
      display: flex;
      flex-direction: column;
    }
    .sidebar.open {
      transform: translateX(0);
    }
    .sidebar-header {
      padding: 1rem;
      background-color: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sidebar-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
    }
    .close-button {
      background: none;
      border: none;
      cursor: pointer;
      color: #6b7280;
      transition: color 0.2s;
    }
    .close-button:hover {
      color: #1f2937;
    }
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }
    .statement-card {
      background-color: #f9fafb;
      border-radius: 0.75rem;
      padding: 1.5rem;
    }
    .statement-person {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }
    .statement-text {
      color: #4b5563;
      line-height: 1.6;
      font-size: 1rem;
    }
    .sidebar-footer {
      padding: 1rem;
      background-color: #f9fafb;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
    }
    .nav-button {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: none;
      border: 1px solid #d1d5db;
      color: #4b5563;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .nav-button:hover {
      background-color: #f3f4f6;
      border-color: #9ca3af;
    }
    .nav-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ANIMATIONS */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* REACTIONS */
    .reaction-bar {
      display: flex;
      width: 100%;
      height: 10px;
      background-color: #e5e7eb;
      border-radius: 5px;
      overflow: hidden;
      margin: 10px 0;
      position: relative;
    }
    .likes-bar {
      background-color: #3b82f6;
      height: 100%;
      transition: width 0.3s;
    }
    .dislikes-bar {
      background-color: #ef4444;
      height: 100%;
      transition: width 0.3s;
    }
    .reaction-options {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }
    .reaction-button {
      padding: 5px 10px;
      border: 1px solid #d1d5db;
      border-radius: 5px;
      background-color: #f9fafb;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .reaction-button:hover {
      background-color: #e5e7eb;
    }
    .reaction-button.active,
    .reaction-button.selected {
      background-color: #d1d5db;
      font-weight: bold;
    }

    /* RESPONSIVE */
    @media screen and (max-width: 768px) {
      .example-questions {
        grid-template-columns: 1fr;
      }
      .message {
        max-width: 90%;
      }
      .send-text {
        display: none;
      }
      .sidebar {
        width: 100%;
      }
      .profile-sidebar {
        width: 100%;
      }
      .personalization-container {
        display: none; /* Hide slider on small screens */
      }
    }

    /* LOADING SPINNER ON INPUT */
    .input-container {
      position: relative;
    }
    .chat-input.loading {
      pointer-events: none;
    }
    .chat-input.loading::after {
      content: "";
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      width: 1.25rem;
      height: 1.25rem;
      border: 2px solid #888;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin {
      to {
        transform: translateY(-50%) rotate(360deg);
      }
    }

    /* HISTORY BUTTON */
    .history-toggle-btn {
      background-color: #3b82f6;
      color: #fff;
      border: none;
      padding: 0.5rem 0.75rem;
      width: 130px;
      border-radius: 0.4rem;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.2s;
    }
    .history-toggle-btn:hover {
      background-color: #2563eb;
    }

    /* HISTORY PANEL as a side panel on the left */
    .chat-history {
      position: fixed;
      /* no overlay */
      left: -300px; /* hide it off-screen by default */
      width: 300px; /* panel width */
      top: auto;
      height:80vh;
      background-color: #fff;
      border-right: 1px solid #e5e7eb;
      padding: 1rem;
      box-shadow: 2px 0 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 201;
      transition: left 0.3s ease-in-out;
      overflow-y: auto;
    }
    /* Slide panel in when .open */
    .chat-history.open {
      left: 0;
    }

    /* Inside the history panel */
    .chat-history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .chat-history-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: #1f2937;
    }
    .close-history-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #6b7280;
      transition: color 0.2s;
    }
    .close-history-btn:hover {
      color: #1f2937;
    }

    /* Date group labels */
    .history-group-title {
      margin-top: 1rem;
      font-weight: 600;
      color: #374151;
    }

    /* Individual conversation items */
    .history-item {
      margin-left: 0.5rem;
      margin-top: 0.25rem;
      color: #4b5563;
      cursor: pointer;
      transition: color 0.2s;
    }
    .history-item:hover {
      color: #1f2937;
    }

    /* Optional hidden class for anything else */
    .hidden {
      display: none;
    }

    /* Personalization Settings Container */
    .personalization-settings {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-right: 0.5rem;
    }

    /* Personalization Label */
    .personalization-label {
      font-weight: 600;
      color: #1f2937;
      font-size: 0.9rem;
    }

    /* Personalization Slider Container */
    .personalization-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Slider Styling */
    #personalization-slider {
      width: 100px;
    }

    /* Slider Value Display */
    #slider-value {
      font-size: 0.9rem;
      color: #4b5563;
      min-width: 40px;
      text-align: right;
    }

    /* Profile Button Styling */
    .profile-button {
      background-color: #6b7280;
      color: #fff;
      border: none;
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background-color 0.2s;
      align-self: flex-start; /* Align the button to the start */
    }

    .profile-button:hover {
      background-color: #4b5563;
    }

    .profile-button svg {
      display: block;
    }

    /* Profile Overlay */
    .profile-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      pointer-events: none;
      z-index: 150; /* Above chat-history */
    }
    .profile-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    /* Profile Sidebar */
    .profile-sidebar {
      position: fixed;
      top: 0;
      right: -400px; /* Hidden by default */
      bottom: 0;
      width: 400px;
      background-color: #fff;
      box-shadow: -2px 0 6px -1px rgba(0, 0, 0, 0.1);
      transition: right 0.3s ease-in-out;
      z-index: 151;
      display: flex;
      flex-direction: column;
    }
    .profile-sidebar.open {
      right: 0;
    }

    /* Profile Header */
    .profile-header {
      padding: 1rem;
      background-color: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .profile-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
    }

    /* Profile Content */
    .profile-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }
    .profile-content label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #1f2937;
    }
    #subjects-input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-size: 1rem;
      color: #4b5563;
    }
    .subjects-visualization {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .subject-item {
      background-color: #e5e7eb;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
    }
    .subject-item span {
      margin-right: 0.5rem;
    }
    .subject-item button {
      background: none;
      border: none;
      cursor: pointer;
      color: #6b7280;
      font-weight: bold;
    }
    .subject-item button:hover {
      color: #1f2937;
    }

    /* Save Profile Button */
    .save-profile-button {
      padding: 0.75rem 1.25rem;
      background-color: #10b981;
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .save-profile-button:hover {
      background-color: #059669;
    }
    .save-profile-button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }

  </style>
</head>
<body>

<div class="chat-container">
  <!-- MAIN CHAT AREA -->
  <div class="chat-main">

    <!-- History Side Panel (off-screen by default) -->
    <aside id="chat-history" class="chat-history">
      <div class="chat-history-header">
        <h3>Conversation History</h3>
        <button id="close-history-btn" class="close-history-btn" title="Close">
          <!-- close icon -->
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div id="chat-history-list"><!-- Dynamically populated --></div>
    </aside>

    <!-- Example Questions -->
    <div class="example-questions">
      <!-- History Toggle Button in the grid -->


      {% for example in texts.example_questions %}
      <div class="example-question" data-question="{{ example.question }}">
        {{ example.icon }} {{ example.text }}
      </div>
      {% endfor %}
    </div>
      <button id="toggle-history-btn" class="history-toggle-btn">{{texts.show_history}}</button>

    <!-- Messages Container -->
    <div class="messages-container" id="messages-container"></div>

    <!-- Input Area -->
    <div class="input-container">
      <input
        type="text"
        class="chat-input"
        id="chat-input"
        placeholder="{{ texts.input_placeholder }}"
        autocomplete="off"
      >

      <!-- Personalization Settings -->
      <div class="personalization-settings">
        <label for="personalization-slider" class="personalization-label">Personalization strength</label>
        <div class="personalization-container">
          <input type="range" id="personalization-slider" min="0" max="100" value="{{ preferences.personalization_weight  }}">
          <span id="slider-value">{{ preferences.personalization_weight  }}%</span>
        </div>
        <button class="profile-button" id="profile-button" title="Profile">
          <!-- Profile Icon -->
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="7" r="4"></circle>
            <path d="M5.5 21h13a2 2 0 002-2V7a2 2 0 00-2-2h-13a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
        </button>
      </div>

      <button class="send-button" id="send-button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path>
        </svg>
        <span class="send-text">{{ texts.send_button }}</span>
      </button>
    </div>
  </div>

  <!-- Statement Sidebar -->
  <div class="sidebar-overlay"></div>
  <div class="sidebar" id="statement-sidebar">
    <div class="sidebar-header">
      <h2>{{ texts.sidebar_title }}</h2>
      <button class="close-button" data-action="close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="sidebar-content"></div>
    <div class="sidebar-footer">
      <button class="nav-button" data-action="previous" disabled>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"></path>
        </svg>
        {{ texts.previous_button }}
      </button>
      <button class="nav-button" data-action="next" disabled>
        {{ texts.next_button }}
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 18l6-6-6-6"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Profile Overlay -->
  <div class="profile-overlay"></div>
  <div class="profile-sidebar" id="profile-sidebar">
    <div class="profile-header">
      <h2>User Profile</h2>
      <button class="close-button" id="close-profile-btn" title="Close">
        <!-- Close Icon -->
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="profile-content">
      <label for="subjects-input">Subjects of Interest:</label>
      <input type="text" id="subjects-input" placeholder="Enter subjects separated by commas">
      <div id="subjects-visualization" class="subjects-visualization"></div>
      <button class="save-profile-button" id="save-profile-button">Save</button>
    </div>
  </div>
</div>

<!-- Marked for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const toggleHistoryBtn = document.getElementById('toggle-history-btn');
  const closeHistoryBtn = document.getElementById('close-history-btn');
  const chatHistoryPanel = document.getElementById('chat-history');
  const chatContainer = document.querySelector('.chat-container');

  function openHistory() {
    chatHistoryPanel.classList.add('open');
    // Move the main container to the right
    chatContainer.classList.add('move-right');
  }
  function closeHistory() {
    chatHistoryPanel.classList.remove('open');
    // Move the main container back to the left
    chatContainer.classList.remove('move-right');
  }

  toggleHistoryBtn.addEventListener('click', async () => {
    if (!chatHistoryPanel.classList.contains('open')) {
      openHistory();
      await loadChatHistory(); // load from the server
    } else {
      closeHistory();
    }
  });

  // Extra close button inside the panel
  closeHistoryBtn.addEventListener('click', closeHistory);

  // **Slider Value Update**
  const personalizationSlider = document.getElementById('personalization-slider');
  const sliderValueDisplay = document.getElementById('slider-value');

  personalizationSlider.addEventListener('input', () => {
    sliderValueDisplay.textContent = `${personalizationSlider.value}%`;

  });
});
// **Slider Value Update and Database Update on Release**
  const personalizationSlider = document.getElementById('personalization-slider');
  const sliderValueDisplay = document.getElementById('slider-value');

  personalizationSlider.addEventListener('change', async () => {  // 'change' fires on slider release
    const newValue = personalizationSlider.value;
    sliderValueDisplay.textContent = `${newValue}%`;

    try {
      const response = await fetch('/save_search_preferences', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          personalization: parseInt(newValue, 10)  // Ensure it's an integer
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to update personalization weight.');
      }

      const data = await response.json();
      console.log('Personalization weight updated:', data.settings.personalization_weight);
      // Optionally, update the UI or notify the user
    } catch (error) {
      console.error('Error updating personalization weight:', error);
      alert(`Error: ${error.message}`);
    }
  });


/** The main chat interface class **/
class ChatInterface {
  constructor() {
    this.currentCitations = [];
    this.isWaitingForResponse = false;
    this.sidebar = new StatementSidebar();
    this.initialize();
  }

  initialize() {
    // Add welcome message
    this.addMessage("{{texts.welcome_msg}}", 'bot');

    // Setup input events
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');

    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey && !this.isWaitingForResponse) {
        e.preventDefault();
        this.sendMessage();
      }
    });

    chatInput.addEventListener('input', () => {
      sendButton.disabled = !chatInput.value.trim() || this.isWaitingForResponse;
    });

    sendButton.addEventListener('click', () => this.sendMessage());

    // Example questions
    document.querySelectorAll('.example-question').forEach(question => {
      question.addEventListener('click', () => {
        this.sendExample(question.dataset.question);
      });
    });
  }

  async sendMessage() {
    const input = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const personalization = document.getElementById('personalization-slider').value; // Get slider value
    const message = input.value.trim();

    if (!message || this.isWaitingForResponse) return;

    this.isWaitingForResponse = true;
    input.disabled = true;
    sendButton.disabled = true;
    input.classList.add('loading'); // show spinner

    // Show user message
    this.addMessage(message, 'user');
    input.value = '';

    try {
      const conversationId = window.currentConversationId || null;

      const response = await fetch('/ask', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          question: message,
          language: "{{current_lang}}",
          conversation_id: conversationId,
          personalization: personalization // Include personalization
        })
      });

      if (!response.ok) throw new Error('API request failed');

      const data = await response.json();

      // If new conversation ID assigned
      if (data.conversation_id && !window.currentConversationId) {
        window.currentConversationId = data.conversation_id;
      }

      this.addMessage(data.response, 'bot', data.statements);

    } catch (error) {
      console.error('Error:', error);
      this.addMessage('Sorry, I encountered an error. Please try again.', 'bot');
    } finally {
      this.isWaitingForResponse = false;
      input.disabled = false;
      sendButton.disabled = !input.value.trim();
      input.classList.remove('loading'); // remove spinner
      input.focus();
    }
  }

  sendExample(question) {
    const input = document.getElementById('chat-input');
    input.value = question;
    this.sendMessage();
  }

  addMessage(content, type, citations = null) {
    const messagesContainer = document.getElementById('messages-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;

    // Actual icons for user & bot:
    const userIcon = `
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4
          -4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8
          1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
      </svg>
    `;
    const botIcon = `
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M9 2v2H7c-1.1 0-2 .9-2 2v2H4c-1.1
        0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9
        2-2V10c0-1.1-.9-2-2-2h-1V6c0-1.1-.9-2-2-2h-2V2H9zM6
        14a2 2 0 100-4 2 2 0 000 4zm8 0a2 2 0 100-4
        2 2 0 000 4z"/>
      </svg>
    `;

    const iconSvg = (type === 'user') ? userIcon : botIcon;

    // If it's a bot message, interpret as Markdown
    const renderedContent = (type === 'bot') ? marked.parse(content) : content;

    let messageContent = `
      <div class="message-header">
        ${iconSvg}
        <span>${type === 'user' ? 'You' : 'Democracy Watch'}</span>
      </div>
      <div class="message-content">${renderedContent}</div>
    `;

    // Citation buttons if needed
    let citationLinksHTML = '';
    if (type === 'bot' && citations && citations.length > 0) {
      this.currentCitations = citations;
      citationLinksHTML = citations
        .map((citation, index) => {
          // Only add a link if the message text references [1], [2], etc.
          if (!content.includes(`[${index + 1}]`)) return '';
          return `<button class="citation-link" onclick="chatInterface.showCitation(${index})">
            [${index + 1}] ${citation.person || 'Citation'}
          </button>`;
        })
        .join('');
    }

    messageDiv.innerHTML = messageContent + citationLinksHTML;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  showCitation(index) {
    const citation = this.currentCitations[index];
    if (!citation || !citation.statement_id) return;
    this.sidebar.loadStatement(citation.statement_id);
  }

  /**
   * Called when a user clicks a conversation item from the history panel.
   * It fetches the conversation from the server, clears the chat, and re-displays messages.
   */
  async initiate_from_conversation_id(convId) {
    console.log(`Initiating from conversation: ${convId}`);
    try {
      const res = await fetch(`/conversation/${convId}`);
      if (!res.ok) throw new Error('Could not load conversation');
      const data = await res.json();

      // Clear the chat
      const messagesContainer = document.getElementById('messages-container');
      messagesContainer.innerHTML = '';

      // Add each message
      if (data.messages && data.messages.length > 0) {
        data.messages.forEach((m) => {
          const type = m.answer ? 'bot' : 'user';
          const content = m.answer || m.question || '';
          this.addMessage(m.question, 'user');
          this.addMessage(m.answer, 'bot', m.statements);
        });
      }
      // Set global conversation ID
      window.currentConversationId = convId;
    } catch (err) {
      console.error(err);
      alert('Failed to load conversation');
    }
  }
  cleanup() {
    this.currentCitations = [];
    this.isWaitingForResponse = false;
    const input = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    if (input) input.value = '';
    if (sendButton) sendButton.disabled = false;
  }
}

/* Statement Sidebar for viewing statements on the right */
class StatementSidebar {
  constructor() {
    this.currentStatementId = null;
    this.isLoading = false;
    this.initialize();
  }

  initialize() {
    this.sidebar = document.getElementById('statement-sidebar');
    this.overlay = document.querySelector('.sidebar-overlay');
    this.content = this.sidebar.querySelector('.sidebar-content');
    this.bindEvents();
  }

  bindEvents() {
    // Close button in the sidebar
    this.sidebar.querySelector('[data-action="close"]').addEventListener('click', () => this.close());

    // Clicking the overlay closes the statement sidebar (optional)
    this.overlay.addEventListener('click', () => this.close());

    // Next / Previous
    this.sidebar.querySelectorAll('.nav-button').forEach(button => {
      button.addEventListener('click', (e) => {
        const direction = e.currentTarget.dataset.action;
        this.loadStatement(this.currentStatementId, direction);
      });
    });

    // Keydown navigation
    document.addEventListener('keydown', (e) => {
      if (!this.sidebar.classList.contains('open')) return;
      switch (e.key) {
        case 'Escape':
          this.close();
          break;
        case 'ArrowLeft':
          this.loadStatement(this.currentStatementId, 'previous');
          break;
        case 'ArrowRight':
          this.loadStatement(this.currentStatementId, 'next');
          break;
      }
    });
  }

  open() {
    this.overlay.classList.add('active');
    this.sidebar.classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  close() {
    this.overlay.classList.remove('active');
    this.sidebar.classList.remove('open');
    document.body.style.overflow = '';
    this.currentStatementId = null;
    this.updateNavigationButtons(true);
  }

  async loadStatement(statementId, direction = null) {
    if (!statementId || this.isLoading) return;

    // Save old content in case next/previous is invalid
    const oldContent = this.content.innerHTML;

    this.currentStatementId = statementId;
    this.isLoading = true;
    this.updateNavigationButtons(true);
    this.open();
    this.showLoading();

    try {
      const url = direction
        ? `/statement?statement_id=${statementId}&direction=${direction}`
        : `/statement?statement_id=${statementId}`;

      const [statementResponse, meetingResponse] = await Promise.all([
        fetch(url),
        fetch(`/meetings?statement_id=${statementId}`)
      ]);

      if (!statementResponse.ok) throw new Error('Failed to fetch statement details');

      const statementData = await statementResponse.json();
      let meetingData = null;

      if (meetingResponse.ok) {
        meetingData = await meetingResponse.json();
      }

      if (statementData && statementData.statement_id) {
        this.currentStatementId = statementData.statement_id;
        this.renderContent(statementData, meetingData);
        this.updateNavigationButtons(false);
      } else {
        throw new Error('Statement not found');
      }
    } catch (error) {
      console.error('Error:', error);

      if (direction === 'next' || direction === 'previous') {
        alert(`There is no ${direction} statement.`);
        this.content.innerHTML = oldContent;
        this.updateNavigationButtons(false);
      } else {
        this.showError(error.message);
      }
    } finally {
      this.isLoading = false;
    }
  }

  renderContent(statementData, meetingData) {
    let content = '';

    // Meeting info if available
    if (meetingData) {
      content += `
        <div class="meeting-info">
          <div class="meeting-header">
            <div class="meeting-title">${meetingData.name || 'Unknown Meeting'}</div>
            <div class="meeting-links">
              ${meetingData.pdf_link ? `
                <a href="${meetingData.pdf_link}" target="_blank" class="meeting-link" title="View PDF">
                  <i class="fas fa-file-pdf"></i>
                </a>` : ''}
              ${meetingData.youtube_link ? `
                <a href="${meetingData.youtube_link}" target="_blank" class="meeting-link" title="Watch on YouTube">
                  <i class="fab fa-youtube"></i>
                </a>` : ''}
            </div>
          </div>
          <div class="meeting-date">
            <i class="far fa-calendar-alt"></i>
            ${this.formatDate(meetingData.date)}
          </div>
          <div class="meeting-location">
            <i class="fas fa-map-marker-alt"></i>
            ${meetingData.region}${meetingData.country ? `, ${meetingData.country}` : ''}
          </div>
        </div>
      `;
    }

    // Reaction counts
    const totalReactions = statementData.likes + statementData.dislikes;
    const likesPercentage = totalReactions > 0 ? (statementData.likes / totalReactions) * 100 : 0;
    const dislikesPercentage = totalReactions > 0 ? (statementData.dislikes / totalReactions) * 100 : 0;

    // Statement card
    content += `
      <div class="statement-card">
        <div class="statement-metadata">
          <div class="statement-person">${statementData.person || 'Unknown Speaker'}</div>
          <div class="statement-date">${statementData.party || 'Unknown Party'}</div>
        </div>
        <div class="statement-text">${statementData.statement || 'No statement text available'}</div>
        <div class="reaction-bar">
          <div class="likes-bar" style="width: ${likesPercentage}%"></div>
          <div class="dislikes-bar" style="width: ${dislikesPercentage}%"></div>
        </div>
        <div class="reaction-counts">
          üëç ${statementData.likes} | üëé ${statementData.dislikes}
        </div>
        <div class="reaction-options">
          <button
            id="like-button"
            class="reaction-button ${statementData.user_reaction === 'like' ? 'selected' : ''}"
            onclick="handleReaction('like', '${statementData.statement_id}')"
          >üëç Like</button>
          <button
            id="dislike-button"
            class="reaction-button ${statementData.user_reaction === 'dislike' ? 'selected' : ''}"
            onclick="handleReaction('dislike', '${statementData.statement_id}')"
          >üëé Dislike</button>
        </div>
      </div>
    `;

    this.content.innerHTML = content;
  }

  showLoading() {
    this.content.innerHTML = `
      <div class="loading">
        <div class="loading-spinner"></div>
        <span>Loading statement details...</span>
      </div>
    `;
  }

  showError(message) {
    this.content.innerHTML = `
      <div class="error">
        ${message}
        <button onclick="chatInterface.sidebar.loadStatement('${this.currentStatementId}')" class="retry-button">
          Try again
        </button>
      </div>
    `;
  }

  formatDate(dateString) {
    if (!dateString) return 'Date not available';
    try {
      return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    } catch {
      return dateString;
    }
  }

  updateNavigationButtons(disable = false) {
    this.sidebar.querySelectorAll('.nav-button').forEach(button => {
      button.disabled = disable;
    });
  }
}

/* Reaction handler for Like/Dislike */
async function handleReaction(reaction, statementId) {
  const userId = 'current_user_id'; // Replace with actual user ID
  const url = (reaction === 'like') ? '/like_statement' : '/dislike_statement';
  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, statement_id: statementId })
    });
    if (response.ok) {
      console.log(`${reaction} recorded for statement ${statementId}`);
      await chatInterface.sidebar.loadStatement(statementId);
    } else {
      console.error('Error:', response.statusText);
    }
  } catch (error) {
    console.error('Error:', error);
  }
}

/* Initialize the chat interface globally */
const chatInterface = new ChatInterface();
window.chatInterface = chatInterface;

function groupByConversation(messages) {
  const conversationMap = {};

  messages.forEach((m) => {
    const cid = m.conversation_id;
    if (!conversationMap[cid]) {
      conversationMap[cid] = {
        conversation_id: cid,
        messages: [],
        updatedAt: m.created_at
      };
    }
    conversationMap[cid].messages.push(m);

    const oldDate = new Date(conversationMap[cid].updatedAt);
    const newDate = new Date(m.created_at);
    if (newDate > oldDate) {
      conversationMap[cid].updatedAt = m.created_at;
    }
  });

  const conversationArray = Object.values(conversationMap);

  conversationArray.sort((a, b) => {
    return new Date(b.updatedAt) - new Date(a.updatedAt);
  });

  return conversationArray;
}
function renderConversationHistory(conversations) {
  const container = document.getElementById('chat-history-list');
  container.innerHTML = '';

  conversations.forEach(conv => {
    const displayText = conv.messages[0].conversation_title
      ? truncateString(conv.messages[0].conversation_title, 30)
      : '(no question)';

    const itemDiv = document.createElement('div');
    itemDiv.className = 'history-item';
    itemDiv.textContent = displayText;

    itemDiv.addEventListener('click', () => {
      chatInterface.initiate_from_conversation_id(conv.conversation_id);
    });

    container.appendChild(itemDiv);
  });
}

/** Chat History Methods **/
async function loadChatHistory() {
  try {
    const response = await fetch('/chat_history');
    if (!response.ok) throw new Error('Failed to load history.');

    const data = await response.json();
    const messages = data.messages || [];

    // Use the date-group approach or conversation grouping:
    const grouped = groupMessagesByRelativeDate(messages);
    renderGroupedHistory(grouped);

  } catch (err) {
    console.error('Error loading chat history:', err);
  }
}

function groupMessagesByRelativeDate(messages) {
  const now = new Date();
  const groupsMap = {
    today: { label: 'Today', items: [] },
    yesterday: { label: 'Yesterday', items: [] },
    lastWeek: { label: 'Last Week', items: [] },
    lastMonth: { label: 'Last Month', items: [] },
    older: { label: 'Older', items: [] },
  };

  messages.forEach(msg => {
    const msgDate = new Date(msg.created_at);
    const diffDays = (now - msgDate) / (1000 * 60 * 60 * 24);

    if (diffDays < 1) groupsMap.today.items.push(msg);
    else if (diffDays < 2) groupsMap.yesterday.items.push(msg);
    else if (diffDays < 7) groupsMap.lastWeek.items.push(msg);
    else if (diffDays < 30) groupsMap.lastMonth.items.push(msg);
    else groupsMap.older.items.push(msg);
  });

  return Object.values(groupsMap).filter(group => group.items.length > 0);
}

function renderGroupedHistory(grouped) {
  const container = document.getElementById('chat-history-list');
  container.innerHTML = '';

  grouped.forEach((group) => {
    const groupTitle = document.createElement('div');
    groupTitle.className = 'history-group-title';
    groupTitle.textContent = group.label;
    container.appendChild(groupTitle);

    group.items.forEach((msg) => {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'history-item';
      itemDiv.textContent = msg.conversation_title
        ? `Q: ${truncateString(msg.conversation_title, 30)}`
        : '(no question)';
      itemDiv.addEventListener('click', () => {
        chatInterface.initiate_from_conversation_id(msg.conversation_id);
      });
      container.appendChild(itemDiv);
    });
  });
}

function truncateString(str, maxLength) {
  if (!str) return '';
  return str.length > maxLength ? str.slice(0, maxLength) + '...' : str;
}

/* Load an entire conversation when user clicks a history item */
async function loadConversation(conversationId) {
  if (!conversationId) return;
  try {
    const res = await fetch(`/conversation/${conversationId}`);
    if (!res.ok) throw new Error('Could not load conversation');
    const data = await res.json();

    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.innerHTML = '';

    if (data.messages && data.messages.length > 0) {
      data.messages.forEach((m) => {
        const type = m.answer ? 'bot' : 'user';
        const content = m.answer || m.question || '';
        chatInterface.addMessage(content, type);
      });
    }
    window.currentConversationId = conversationId;
  } catch (err) {
    console.error(err);
    alert('Failed to load conversation');
  }
}
document.addEventListener('DOMContentLoaded', () => {
  loadChatHistory();
});

// **Profile Overlay Elements**
const profileButton = document.getElementById('profile-button');
const profileOverlay = document.querySelector('.profile-overlay');
const profileSidebar = document.getElementById('profile-sidebar');
const closeProfileBtn = document.getElementById('close-profile-btn');
const subjectsInput = document.getElementById('subjects-input');
const subjectsVisualization = document.getElementById('subjects-visualization');
const saveProfileButton = document.getElementById('save-profile-button');

// Function to open profile overlay
function openProfile() {
  profileOverlay.classList.add('active');
  profileSidebar.classList.add('open');
  loadSearchPreferences();
}

// Function to close profile overlay
function closeProfile() {
  profileOverlay.classList.remove('active');
  profileSidebar.classList.remove('open');
}

// Event listeners for opening and closing profile
profileButton.addEventListener('click', openProfile);
closeProfileBtn.addEventListener('click', closeProfile);
profileOverlay.addEventListener('click', closeProfile);

// Load search preferences from /search_preferences
async function loadSearchPreferences() {
  try {
    const response = await fetch('/search_preferences');
    if (!response.ok) throw new Error('Failed to load search preferences.');

    const data = await response.json();
    const subjects = data.subjects || [];
    const sliderValue = data.preferences.personalization_weight  || 50;

    // Set slider value
    document.getElementById('personalization-slider').value = sliderValue;
    document.getElementById('slider-value').textContent = `${sliderValue}%`;

    // Set subjects input
    subjectsInput.value = subjects.join(', ');

    // Visualize subjects
    renderSubjects(subjects);
  } catch (error) {
    console.error('Error loading search preferences:', error);
    alert('Failed to load your search preferences. Please try again.');
  }
}

// Render subjects as visual items
function renderSubjects(subjects) {
  subjectsVisualization.innerHTML = '';
  subjects.forEach((subject, index) => {
    const subjectItem = document.createElement('div');
    subjectItem.className = 'subject-item';
    subjectItem.innerHTML = `
      <span>${subject.trim()}</span>
      <button data-index="${index}">&times;</button>
    `;
    subjectsVisualization.appendChild(subjectItem);
  });
}

// Handle adding subjects from input
subjectsInput.addEventListener('change', () => {
  const subjects = subjectsInput.value.split(',').map(s => s.trim()).filter(s => s);
  renderSubjects(subjects);
});

// Handle removing a subject
subjectsVisualization.addEventListener('click', (e) => {
  if (e.target.tagName.toLowerCase() === 'button') {
    const index = e.target.getAttribute('data-index');
    const subjects = subjectsInput.value.split(',').map(s => s.trim()).filter(s => s);
    subjects.splice(index, 1);
    subjectsInput.value = subjects.join(', ');
    renderSubjects(subjects);
  }
});

// Save search preferences
saveProfileButton.addEventListener('click', async () => {
  const subjects = subjectsInput.value.split(',').map(s => s.trim()).filter(s => s);
  const personalization = document.getElementById('personalization-slider').value;

  saveProfileButton.disabled = true;
  saveProfileButton.textContent = 'Saving...';

  try {
    const response = await fetch('/save_search_preferences', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ subjects, personalization })
    });

    if (!response.ok) throw new Error('Failed to save search preferences.');

    alert('Your search preferences have been saved successfully.');
    closeProfile();
  } catch (error) {
    console.error('Error saving search preferences:', error);
    alert('Failed to save your search preferences. Please try again.');
  } finally {
    saveProfileButton.disabled = false;
    saveProfileButton.textContent = 'Save';
  }
});
</script>

</body>
</html>
